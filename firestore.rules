rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =================================================================
    // üõ°Ô∏è SECURITY MODEL v2: Operational Staff
    // 1. GUEST (Not in DB): Blocked completely.
    // 2. STAFF (In DB): Can View AND Operate (Add/Delete Sales).
    // 3. ADMIN (In DB + role='admin'): Can Manage Users.
    // =================================================================
    
    // -----------------------------------------------------------------
    // HELPER FUNCTIONS
    // -----------------------------------------------------------------

    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserDoc() {
      return get(/databases/$(database)/documents/authorized_users/$(request.auth.token.email));
    }

    // IS STAFF? (Anyone in the authorized list is considered Staff)
    function isStaff() {
      return isAuthenticated() && exists(/databases/$(database)/documents/authorized_users/$(request.auth.token.email));
    }

    // IS ADMIN? (Must have specific role)
    function isAdmin() {
      return isStaff() && getUserDoc().data.role == 'admin';
    }
    
    function isValidTransaction() {
      return request.resource.data.amount is number
             && request.resource.data.type in ['sale', 'expense']
             && request.resource.data.description is string;
    }

    // -----------------------------------------------------------------
    // COLLECTION RULES
    // -----------------------------------------------------------------

    // 1. Authorized Users List
    match /authorized_users/{email} {
      // Users can see their own entry
      allow read: if isAuthenticated() && request.auth.token.email == email;
      
      // ONLY Admins can manage the staff list
      allow write: if isAdmin();
    }

    // 2. Transactions (Sales & Expenses)
    match /transactions/{transactionId} {
      // READ, CREATE, DELETE: Allowed for ALL Staff (so they can sell & fix mistakes)
      allow read, create, delete: if isStaff();
      
      // Update check still validates data
      allow update: if isStaff() && isValidTransaction();
    }
    
  }
}
